@page "/source"
@rendermode InteractiveServer

@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.DataGrid
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Web
@using Volunteer.Models
@using Volunteer.Services
@using Volunteer.Components
@using SourceModel = Volunteer.Models.Source

@inject ISourceService _sourceService

<PageTitle>Sources</PageTitle>

<AuthorizedView RequiresAdmin="true">

<style>
    .source-grid {
        --fluent-data-grid-cell-height: 40px;
    }

    .editable-row {
        cursor: pointer;
    }

    .editable-row:hover {
        background-color: var(--fill-color);
    }

    .search-row {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 8px;
        margin: 16px 0;
        align-items: center;
    }

    .search-input {
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        width: 100%;
    }

    .wide-button {
        min-width: 120px;
    }

    .standard-button {
        min-width: 100px;
    }
</style>

<br />

<!-- Add Source and Clear Search Buttons -->
<div style="margin: 8px 0;">
    <FluentButton Appearance="Appearance.Accent" @onclick="OpenAddDialog" Class="wide-button" style="margin-right: 16px;">Add Source</FluentButton>
    <FluentButton Appearance="Appearance.Neutral" @onclick="ClearSearch" Class="standard-button">Clear Search</FluentButton>
</div>

<br />

<!-- Search Field -->
<div class="search-row">
    <input type="text" id="nameSearch" @bind="searchText" @oninput="OnSearchInput" placeholder="Search by name..."
        class="search-input" />
</div>

<!-- Datagrid -->
<FluentDataGrid Items="@GetFilteredSources()" TGridItem="SourceModel" Class="source-grid"
    RowClass="@(_ => "editable-row")" OnRowDoubleClick="@OnRowDoubleClick">
    <PropertyColumn Title="Source" Property="@(p => p.Name)" />
    <PropertyColumn Title="Created" Property="@(p => p.DateCreated)" Format="MM/dd/yyyy" />
    <PropertyColumn Title="Modified" Property="@(p => p.DateModified)" Format="MM/dd/yyyy" />
    <TemplateColumn Title="Actions">
        <FluentButton Appearance="Appearance.Lightweight" @onclick="async () => await OpenEditDialog(context)" 
            IconEnd="@(new Icons.Regular.Size16.Edit())" Title="Edit" />
        @* <FluentButton Appearance="Appearance.Lightweight" @onclick="() => DeleteSource(context)" 
            IconEnd="@(new Icons.Regular.Size16.Delete())" Title="Delete" /> *@
    </TemplateColumn>
</FluentDataGrid>

<br />

<p style="font-size: 12px; color: #666; margin-top: 8px;">Double-click any row to edit</p>

<!-- Simple Dialog for Add/Edit -->
<FluentDialog @ref="sourceDialog" Hidden="@(!_showDialog)" TrapFocus="true" Modal="true" OnDismiss="CloseDialog" @onkeydown="@((e) => HandleKeyDown(e))">
    <FluentDialogHeader>
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <h3 style="margin: 0;">@(_isEditMode ? "Edit Source" : "Add New Source")</h3>
            <FluentButton 
                Appearance="Appearance.Lightweight"
                @onclick="CloseDialog"
                Title="Finish"
                IconEnd="@(new Icons.Regular.Size16.Dismiss())"
                style="min-width: 32px; padding: 4px;" />
        </div>
    </FluentDialogHeader>

    <FluentDialogBody>
        <EditForm Model="@_currentSource" OnValidSubmit="SaveSource" FormName="SourceForm">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <FluentStack Orientation="Orientation.Vertical" Gap="3" Style="min-width: 300px;">
                <FluentTextField @ref="nameField" Label="Source Name:" @bind-Value="_currentSource.Name"
                    Required="true" Style="width: 100%;" />
            </FluentStack>
        </EditForm>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" @onclick="SaveSource" Class="standard-button">Save</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" @onclick="CloseDialog" Class="standard-button">Cancel</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<SourceModel> _sourceList = new();
    private FluentDialog? sourceDialog;
    private FluentTextField? nameField;
    private string searchText = string.Empty;
    private bool _showDialog = false;
    private bool _isEditMode = false;
    private SourceModel _currentSource = new();

    // --------------------------------------------------------------------
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _sourceList = await _sourceService.ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading sources: {ex.Message}");
        }
    }

    // --------------------------------------------------------------------
    // Search Methods
    // --------------------------------------------------------------------

    private IQueryable<SourceModel> GetFilteredSources()
    {
        var filteredSources = _sourceList.AsQueryable();

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            filteredSources = filteredSources.Where(i => i.Name != null &&
                i.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }

        return filteredSources.OrderBy(i => i.Name);
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }

    private void ClearSearch()
    {
        searchText = string.Empty;
        StateHasChanged();
    }

    // --------------------------------------------------------------------
    // Dialog Methods
    // --------------------------------------------------------------------

    private async Task OpenAddDialog()
    {
        _currentSource = new SourceModel();
        _isEditMode = false;
        _showDialog = true;
        StateHasChanged();
        await Task.Delay(50); // Small delay to ensure dialog is rendered
        await FocusNameField();
    }

    private async Task OpenEditDialog(SourceModel source)
    {
        _currentSource = new SourceModel 
        { 
            SourceId = source.SourceId, 
            Name = source.Name 
        };
        _isEditMode = true;
        _showDialog = true;
        StateHasChanged();
        await Task.Delay(50); // Small delay to ensure dialog is rendered
        await FocusNameField();
    }

    private void CloseDialog()
    {
        _showDialog = false;
        _currentSource = new SourceModel();
        StateHasChanged();
    }

    // --------------------------------------------------------------------

    private async Task SaveSource()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_currentSource.Name))
                return;

            Console.WriteLine($"Saving Source: ID={_currentSource.SourceId}, Name='{_currentSource.Name}', IsEditMode={_isEditMode}");

            if (_isEditMode)
            {
                await _sourceService.UpdateAsync(_currentSource);
                Console.WriteLine("Source updated successfully");
            }
            else
            {
                await _sourceService.AddAsync(_currentSource);
                Console.WriteLine("Source added successfully");
            }

            _sourceList = await _sourceService.ToListAsync(); // Refresh the list
            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving source: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    // --------------------------------------------------------------------

    private async Task DeleteSource(SourceModel source)
    {
        try
        {
            await _sourceService.DeleteAsync(source.SourceId);
            _sourceList = await _sourceService.ToListAsync(); // Refresh the list
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting source: {ex.Message}");
        }
    }

    // --------------------------------------------------------------------

    private async void OnRowDoubleClick(FluentDataGridRow<SourceModel> row)
    {
        await OpenEditDialog(row.Item!);
    }

    // --------------------------------------------------------------------

    private async Task FocusNameField()
    {
        try
        {
            if (nameField != null)
            {
                await nameField.Element!.FocusAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error setting focus: {ex.Message}");
        }
    }

    // --------------------------------------------------------------------

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            CloseDialog();
        }
    }

    // --------------------------------------------------------------------
}

</AuthorizedView>
