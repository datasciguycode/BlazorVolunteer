@page "/skill"
@rendermode InteractiveServer

@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.DataGrid
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Web
@using Volunteer.Models
@using Volunteer.Services
@using Volunteer.Components
@using SkillModel = Volunteer.Models.Skill

@inject ISkillService _skillService

<PageTitle>Skills</PageTitle>

<AuthorizedView RequiresAdmin="true">

<style>
    .skill-grid {
        --fluent-data-grid-cell-height: 40px;
    }

    .editable-row {
        cursor: pointer;
    }

    .editable-row:hover {
        background-color: var(--fill-color);
    }

    .search-row {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 8px;
        margin: 16px 0;
        align-items: center;
    }

    .search-input {
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        width: 100%;
    }

    .wide-button {
        min-width: 120px;
    }

    .standard-button {
        min-width: 100px;
    }
</style>

<br />

<!-- Add Skill and Clear Search Buttons -->
<div style="margin: 8px 0;">
    <FluentButton Appearance="Appearance.Accent" @onclick="OpenAddDialog" Class="wide-button" style="margin-right: 16px;">Add Skill</FluentButton>
    <FluentButton Appearance="Appearance.Neutral" @onclick="ClearSearch" Class="standard-button">Clear Search</FluentButton>
</div>

<br />

<!-- Search Field -->
<div class="search-row">
    <input type="text" id="nameSearch" @bind="searchText" @oninput="OnSearchInput" placeholder="Search by name..."
        class="search-input" />
</div>

<!-- Datagrid -->
<FluentDataGrid Items="@GetFilteredSkills()" TGridItem="SkillModel" Class="skill-grid"
    RowClass="@(_ => "editable-row")" OnRowDoubleClick="@OnRowDoubleClick">
    <PropertyColumn Title="Skill" Property="@(p => p.Name)" />
    <PropertyColumn Title="Created" Property="@(p => p.DateCreated)" Format="MM/dd/yyyy" />
    <PropertyColumn Title="Modified" Property="@(p => p.DateModified)" Format="MM/dd/yyyy" />
    <TemplateColumn Title="Actions">
        <FluentButton Appearance="Appearance.Lightweight" @onclick="async () => await OpenEditDialog(context)" 
            IconEnd="@(new Icons.Regular.Size16.Edit())" Title="Edit" />
        @* <FluentButton Appearance="Appearance.Lightweight" @onclick="() => DeleteSkill(context)" 
            IconEnd="@(new Icons.Regular.Size16.Delete())" Title="Delete" /> *@
    </TemplateColumn>
</FluentDataGrid>

<br />

<p style="font-size: 12px; color: #666; margin-top: 8px;">Double-click any row to edit</p>

<!-- Simple Dialog for Add/Edit -->
<FluentDialog @ref="skillDialog" Hidden="@(!_showDialog)" TrapFocus="true" Modal="true" OnDismiss="CloseDialog" @onkeydown="@((e) => HandleKeyDown(e))">
    <FluentDialogHeader>
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <h3 style="margin: 0;">@(_isEditMode ? "Edit Skill" : "Add New Skill")</h3>
            <FluentButton 
                Appearance="Appearance.Lightweight"
                @onclick="CloseDialog"
                Title="Finish"
                IconEnd="@(new Icons.Regular.Size16.Dismiss())"
                style="min-width: 32px; padding: 4px;" />
        </div>
    </FluentDialogHeader>

    <FluentDialogBody>
        <EditForm Model="@_currentSkill" OnValidSubmit="SaveSkill" FormName="SkillForm">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <FluentStack Orientation="Orientation.Vertical" Gap="3" Style="min-width: 300px;">
                <FluentTextField @ref="nameField" Label="Skill Name:" @bind-Value="_currentSkill.Name"
                    Required="true" Style="width: 100%;" />
            </FluentStack>
        </EditForm>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" @onclick="SaveSkill" Class="standard-button">Save</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" @onclick="CloseDialog" Class="standard-button">Cancel</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<SkillModel> _skillList = new();
    private FluentDialog? skillDialog;
    private FluentTextField? nameField;
    private string searchText = string.Empty;
    private bool _showDialog = false;
    private bool _isEditMode = false;
    private SkillModel _currentSkill = new();

    // --------------------------------------------------------------------
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _skillList = await _skillService.ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading skills: {ex.Message}");
        }
    }

    // --------------------------------------------------------------------
    // Search Methods
    // --------------------------------------------------------------------

    private IQueryable<SkillModel> GetFilteredSkills()
    {
        var filteredSkills = _skillList.AsQueryable();

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            filteredSkills = filteredSkills.Where(i => i.Name != null &&
                i.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }

        return filteredSkills.OrderBy(i => i.Name);
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }

    private void ClearSearch()
    {
        searchText = string.Empty;
        StateHasChanged();
    }

    // --------------------------------------------------------------------
    // Dialog Methods
    // --------------------------------------------------------------------

    private async Task OpenAddDialog()
    {
        _currentSkill = new SkillModel();
        _isEditMode = false;
        _showDialog = true;
        StateHasChanged();
        await Task.Delay(50); // Small delay to ensure dialog is rendered
        await FocusNameField();
    }

    private async Task OpenEditDialog(SkillModel skill)
    {
        _currentSkill = new SkillModel 
        { 
            SkillId = skill.SkillId, 
            Name = skill.Name 
        };
        _isEditMode = true;
        _showDialog = true;
        StateHasChanged();
        await Task.Delay(50); // Small delay to ensure dialog is rendered
        await FocusNameField();
    }

    private void CloseDialog()
    {
        _showDialog = false;
        _currentSkill = new SkillModel();
        StateHasChanged();
    }

    // --------------------------------------------------------------------

    private async Task SaveSkill()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_currentSkill.Name))
                return;

            Console.WriteLine($"Saving Skill: ID={_currentSkill.SkillId}, Name='{_currentSkill.Name}', IsEditMode={_isEditMode}");

            if (_isEditMode)
            {
                await _skillService.UpdateAsync(_currentSkill);
                Console.WriteLine("Skill updated successfully");
            }
            else
            {
                await _skillService.AddAsync(_currentSkill);
                Console.WriteLine("Skill added successfully");
            }

            _skillList = await _skillService.ToListAsync(); // Refresh the list
            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving skill: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    // --------------------------------------------------------------------

    private async Task DeleteSkill(SkillModel skill)
    {
        try
        {
            await _skillService.DeleteAsync(skill.SkillId);
            _skillList = await _skillService.ToListAsync(); // Refresh the list
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting skill: {ex.Message}");
        }
    }

    // --------------------------------------------------------------------

    private async void OnRowDoubleClick(FluentDataGridRow<SkillModel> row)
    {
        await OpenEditDialog(row.Item!);
    }

    // --------------------------------------------------------------------

    private async Task FocusNameField()
    {
        try
        {
            if (nameField != null)
            {
                await nameField.Element!.FocusAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error setting focus: {ex.Message}");
        }
    }

    // --------------------------------------------------------------------

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            CloseDialog();
        }
    }

    // --------------------------------------------------------------------
}

</AuthorizedView>
